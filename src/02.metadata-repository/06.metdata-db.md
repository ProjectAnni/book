# 预构建数据源

为方便客户端使用仓库数据，元数据仓库中的数据可以单向地构建为 `SQLite DB` 的形式供客户端读取。

## 仓库元数据（`repo_info`）

```sql
CREATE TABLE IF NOT EXISTS "repo_info" (
  "key"    TEXT NOT NULL UNIQUE,
  "value"  TEXT
);
```

其中固定的 `key` 如下：

| `key`          | 描述                         |
| -------------- | ---------------------------- |
| `repo_name`    | 仓库名                       |
| `repo_url`     | 仓库地址                     |
| `repo_ref`     | 生成时元数据仓库的 `ref`     |
| `repo_version` | 生成时的元数据仓库的描述版本 |
| `db_version`   | 生成时预构建数据源的描述版本 |

## 专辑（`repo_album`）

```sql
CREATE TABLE IF NOT EXISTS "repo_album" (
  "album_id"       TEXT NOT NULL UNIQUE,
  "title"          TEXT NOT NULL,
  "edition"        TEXT,
  "catalog"        TEXT NOT NULL,
  "artist"         TEXT NOT NULL,
  "release_date"   TEXT NOT NULL,
  "album_type"     TEXT NOT NULL DEFAULT 'normal' CHECK("album_type" IN ('normal', 'instrumental', 'absolute', 'drama', 'radio', 'vocal'))
);

CREATE UNIQUE INDEX "repo_album_index" ON "repo_album" (
  "album_id"
);
```

## 唱片（`repo_disc`）

```sql
CREATE TABLE IF NOT EXISTS "repo_disc" (
  "album_id"    TEXT NOT NULL,
  "disc_id"     INTEGER NOT NULL,
  "title"       TEXT NOT NULL,
  "artist"      TEXT NOT NULL,
  "catalog"     TEXT NOT NULL,
  "disc_type"   TEXT NOT NULL DEFAULT 'normal' CHECK("disc_type" IN ('normal', 'instrumental', 'absolute', 'drama', 'radio', 'vocal')),
  UNIQUE("album_id","disc_id"),
  FOREIGN KEY("album_id") REFERENCES "repo_album"("album_id")
);

CREATE UNIQUE INDEX IF NOT EXISTS "repo_disc_index" ON "repo_disc" (
  "album_id",
  "disc_id"
);
```

## 音轨（`repo_track`）

```sql
CREATE TABLE IF NOT EXISTS "repo_track" (
  "album_id"     TEXT NOT NULL,
  "disc_id"      INTEGER NOT NULL,
  "track_id"     TEXT NOT NULL,
  "title"        TEXT NOT NULL,
  "artist"       TEXT NOT NULL,
  "track_type"   TEXT NOT NULL DEFAULT 'normal' CHECK("track_type" IN ('normal', 'instrumental', 'absolute', 'drama', 'radio', 'vocal')),
  UNIQUE("album_id","disc_id","track_id"),
  FOREIGN KEY("album_id", "disc_id") REFERENCES "repo_disc"("album_id", "disc_id")
);

CREATE UNIQUE INDEX IF NOT EXISTS "repo_track_index" ON "repo_track" (
  "album_id",
  "disc_id",
  "track_id"
);
```

## 标签（`repo_tag`）

```sql
CREATE TABLE IF NOT EXISTS "repo_tag" (
  "album_id"    TEXT NOT NULL,
  "disc_id"     INTEGER,
  "track_id"    INTEGER,
  "name"        TEXT NOT NULL,
  "edition"     TEXT
);

CREATE INDEX IF NOT EXISTS "repo_tag_index" ON "repo_tag" (
  "album_id",
  "disc_id",
  "track_id"
);
```
