# workspace

`anni workspace` 提供了一系列对*本地音频整理工作空间*的管理命令。

## 术语表

| 名称             | 简称       | 详情                                       |
| ---------------- | ---------- | ------------------------------------------ |
| 音频整理工作空间 | 工作空间   | `anni workspace` 工作的目录                |
| 受控部分目录     | 受控目录   | 由 `anni` 控制的，不由用户手动控制的目录   |
| 用户部分目录     | 用户目录   | 由用户手动控制，`anni` 管理状态的目录      |
| 专辑目录         | 专辑       | 用户目录下，实际存放专辑内音频和封面的目录 |
| 专辑状态：未跟踪 | 未跟踪专辑 | 用户未将专辑提交时的状态                   |
| 专辑状态：提交   | 已提交专辑 | 用户提交专辑结构后的状态                   |
| 专辑状态：完成   | 已完成专辑 | 用户完成元数据整理，并已写入专辑后的状态   |

## 工作空间

~~音频整理工作空间看起来有点拗口的样子，之后我们就用工作空间来代替好了~~

工作空间的由来是为了替代掉原有的，没有任何约束的任意目录。工作空间的存在目的有两个：

1. 通过固定的目录结构，防止误操作的出现。
   \
   常见的误操作包括在保种的目录应用元数据、在保种的目录修改音频内嵌封面等修改原文件内容的行为。~~全是血泪史~~
2. 通过一定的机制，简化音频整理的操作。
   \
   在规定了目录结构后，音频目录就可以和元数据文件关联起来。元数据文件的品番在整理过程中可能（由于填写错误）存在变更，但 `AlbumID` 一般不会变化。

## 目录结构

工作空间的目录分为两部分：**受控部分**和**用户部分**。

### 受控部分

受控部分是一个名为 `.anni` 的隐藏目录，结构如下：

```
├── objects
│   ├── 10
│   │   └── 77
│   │       └── 1077d96b-8fd3-4585-a6ab-8eef265a48df
│   ├── 25
│   │   └── eb
│   ├── d2
│   │   └── 74
│   ├── e
│   │   └── ff
│   └── fc
│       └── 50
├── repo
│   ├── album
│   ├── tag
│   ├── repo.toml
│   └── Readme.md
└── config.toml
```

该目录中保存了音频整理所需的两大元素：音频资源和元数据仓库。目前根目录下定义的内容如下：

1. 音频资源，以严格目录格式存放于 `objects` 目录下。
2. 元数据仓库，位于 `repo` 目录。
3. `config.toml`，负责后续记录一些额外的配置信息，暂时为空。

### 用户部分

用户部分是与受控目录 `.anni` 同级的其他目录，可以由用户任意定制。一个典型的用户目录结构如下：

```
├── [A] halca
│   ├── [210519][VVXX-01011] キミがいたしるし
│   │   ├── 01. キミがいたしるし.flac -> ../../.anni/objects/10/77/1077d96b-8fd3-4585-a6ab-8eef265a48df/1/1.flac
│   │   ├── 02. もういいや。.flac -> ../../.anni/objects/10/77/1077d96b-8fd3-4585-a6ab-8eef265a48df/1/2.flac
│   │   ├── 03. キミがいたしるし (TV Size).flac -> ../../.anni/objects/10/77/1077d96b-8fd3-4585-a6ab-8eef265a48df/1/3.flac
│   │   ├── 04. キミがいたしるし (Instrumental).flac -> ../../.anni/objects/10/77/1077d96b-8fd3-4585-a6ab-8eef265a48df/1/4.flac
│   │   ├── 05. もういいや。 (Instrumental).flac -> ../../.anni/objects/10/77/1077d96b-8fd3-4585-a6ab-8eef265a48df/1/5.flac
│   │   ├── .album -> ../../.anni/objects/10/77/1077d96b-8fd3-4585-a6ab-8eef265a48df
│   │   └── cover.jpg -> ../../.anni/objects/10/77/1077d96b-8fd3-4585-a6ab-8eef265a48df/cover.jpg
│   └── [220817][VVXX-01253] 誰彼スクランブル／あれこれドラスティック【Complete Edition】
│       ├── 01. 誰彼スクランブル.flac
│       ├── 02. あれこれドラスティック.flac
│       ├── 03. reprise.flac
│       ├── 04. あれこれドラスティック (halca Ver.).flac
│       ├── 05. 誰彼スクランブル (Remixed by Snail's House).flac
│       ├── 06. 時としてバイオレンス (Remixed by キノシタ).flac
│       ├── 07. 誰彼スクランブル (TV Size).flac
│       ├── 08. あれこれドラスティック (TV Size).flac
│       ├── 09. 誰彼スクランブル (Instrumental).flac
│       ├── 10. あれこれドラスティック (Instrumental).flac
│       ├── 11. reprise (Instrumental).flac
│       ├── .album -> ../../.anni/objects/e1/5/e1057cfd-cd38-4280-bccf-4a48d4cf39f6
│       └── cover.jpg
├── .anni
│   ├── config.toml
│   ├── objects
│   │   └── 10
│   │       └── 77
│   │           └── 1077d96b-8fd3-4585-a6ab-8eef265a48df
│   │               ├── 1
│   │               │   ├── 1.flac
│   │               │   ├── 2.flac
│   │               │   ├── 3.flac
│   │               │   ├── 4.flac
│   │               │   ├── 5.flac
│   │               │   └── cover.jpg
│   │               └── cover.jpg
│   └── repo
└── .directory
```

观察上述目录结构中的 `[A] halca` 部分。用户部分有以下几个特征：

1. 专辑目录可以任意嵌套命名。
2. 在整理过程中，目录中所有文件都是普通文件。
   \
   如 `[220817][VVXX-01253] 誰彼スクランブル／あれこれドラスティック【Complete Edition】`。
3. 在文件基本已经确定后，可以通过命令将所有文件转移到受控目录中，原目录下仅保留该文件的符号链接。
   \
   如 `[210519][VVXX-01011] キミがいたしるし`。
4. 专辑的目录下都存在名为 `.album` 的符号链接，链接到受控目录中的实际专辑位置。
   \
   因此，不存在 `.album` 的目录会被 `anni` 忽略。`anni` 只会处理存在专辑指向的目录。

## 命令

### init

初始化工作空间。

- [ ] `--repo`：从指定位置 `clone` 元数据仓库
- [ ] `--repo-config`：使用元数据仓库的 `repo.toml` 作为工作空间的配置文件
    \
    创建从 `.anni/config.toml` 到 `.anni/repo/repo.toml` 的符号链接。

### create

新建专辑目录。新建的专辑目录状态为**未跟踪**。

- [ ] `-a`, `--album-id`：创建目录的 `Album ID`
- [ ] `-d`, `--disc-num`：创建目录对应的子目录（光盘）数量

### add

将专辑的状态变更为提交。状态变更前，`anni` 会输出一些信息供对比。

- [ ] `-i`, `--import-tags`：变更状态的同时，向元数据仓库导入音频中内嵌的元数据
- [ ] `-y`, `--yes`：跳过信息检查

### update

在提交状态下，对音频或封面文件进行部分更新。

- [ ] `-a`, `--audio`：是否更新音频
- [ ] `-c`, `--cover`：是否更新封面
- [ ] `-m`, `--metadata`：是否写入元数据

### publish

在提交状态下，将专辑的状态变更为完成。

专辑发布后，专辑目录将会被删除。当专辑目录中存在任意非符号链接的正常文件时，发布过程中止。

在支持的操作系统上，发布后的专辑中所有文件的权限都会变更为只读（`r--r--r--`），目录权限会变更为 `r-xr-xr-x`。

- [ ] `-f`, `--force`：当专辑目录中存在非符号链接文件时，强制删除该目录
- [ ] `-d`, `--dest`：发布完成后，新创建链接的目标目录
    \
    专辑发布后，用户可能还会有便捷访问该目录的需求。此时可以通过 `--dest` 指定一个位置，创建一个类似专辑目录结构的新链接目录。
- [ ] `-k`, `--keep-permission`：不修改文件及目录权限
