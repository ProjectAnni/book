# workspace

`anni workspace` 提供了一系列对*本地音频整理工作空间*的管理命令。

## 术语表

| 名称             | 简称       | 详情                                                                      |
| ---------------- | ---------- | ------------------------------------------------------------------------- |
| 音频整理工作空间 | 工作空间   | `anni workspace` 工作的目录                                               |
| 受控部分目录     | 受控目录   | 由 `anni` 控制的，不由用户手动控制的目录                                  |
| 用户部分目录     | 用户目录   | 由用户手动控制，`anni` 管理状态的目录                                     |
| 专辑目录         | 专辑       | 用户目录下，实际存放专辑内音频和封面的目录                                |
| 专辑状态：未跟踪 | 未跟踪专辑 | 用户未将专辑提交时的状态                                                  |
| 专辑状态：提交   | 已提交专辑 | 用户提交专辑结构后的状态                                                  |
| 专辑状态：完成   | 已完成专辑 | 用户完成元数据整理，并已写入专辑后的状态                                  |
| 专辑状态：悬垂   | -          | 用户目录下存在专辑，但受控目录中不存在 `AlbumID` 对应目录，或符号链接错误 |
| 专辑状态：待回收 | -          | 用户目录中不存在该专辑，且该专辑在受控目录中对应为空                      |

## 工作空间

~~音频整理工作空间看起来有点拗口的样子，之后我们就用工作空间来代替好了~~

工作空间的由来是为了替代掉原有的，没有任何约束的任意目录。工作空间的存在目的有两个：

1. 通过固定的目录结构，防止误操作的出现。
   \
   常见的误操作包括在保种的目录应用元数据、在保种的目录修改音频内嵌封面等修改原文件内容的行为。~~全是血泪史~~
2. 通过一定的机制，简化音频整理的操作。
   \
   在规定了目录结构后，音频目录就可以和元数据文件关联起来。元数据文件的品番在整理过程中可能（由于填写错误）存在变更，但 `AlbumID` 一般不会变化。

## 目录结构

工作空间的目录分为两部分：**受控部分**和**用户部分**。

### 受控部分

受控部分位于名为 `.anni` 的隐藏目录中，其结构如下：

```
├── objects
│   ├── 10
│   │   └── 77
│   │       └── 1077d96b-8fd3-4585-a6ab-8eef265a48df
│   ├── 25
│   │   └── eb
│   ├── d2
│   │   └── 74
│   ├── e
│   │   └── ff
│   └── fc
│       └── 50
├── repo
│   ├── album
│   ├── tag
│   ├── repo.toml
│   └── Readme.md
└── config.toml
```

该目录中保存了音频整理所需的两大元素：音频资源和元数据仓库。目前根目录下定义的内容如下：

1. 音频资源，以严格目录格式存放于 `objects` 目录下。
2. 元数据仓库，位于 `repo` 目录。
3. `config.toml`，负责记录一些额外的配置信息。

### 用户部分

用户部分是与受控目录 `.anni` 同级的其他目录，可以由用户任意定制。用户目录结构基本满足约定目录结构，但存在以下区别：

1. 专辑目录中碟片数量的限定将不起作用
2. 碟片目录的名称没有任何限制

### 示例

一个典型的用户目录结构如下：

```
├── [A] halca
│   ├── [210519][VVXX-01011] キミがいたしるし
│   │   ├── 01. キミがいたしるし.flac -> ./.album/1/1.flac
│   │   ├── 02. もういいや。.flac -> ./.album/1/2.flac
│   │   ├── 03. キミがいたしるし (TV Size).flac -> ./.album/1/3.flac
│   │   ├── 04. キミがいたしるし (Instrumental).flac -> ./.album/1/4.flac
│   │   ├── 05. もういいや。 (Instrumental).flac -> ./.album/1/5.flac
│   │   ├── .album -> ../../.anni/objects/10/77/1077d96b-8fd3-4585-a6ab-8eef265a48df
│   │   └── cover.jpg -> ./.album/cover.jpg
│   └── [220817][VVXX-01253] 誰彼スクランブル／あれこれドラスティック【Complete Edition】
│       ├── 01. 誰彼スクランブル.flac
│       ├── 02. あれこれドラスティック.flac
│       ├── 03. reprise.flac
│       ├── 04. あれこれドラスティック (halca Ver.).flac
│       ├── 05. 誰彼スクランブル (Remixed by Snail's House).flac
│       ├── 06. 時としてバイオレンス (Remixed by キノシタ).flac
│       ├── 07. 誰彼スクランブル (TV Size).flac
│       ├── 08. あれこれドラスティック (TV Size).flac
│       ├── 09. 誰彼スクランブル (Instrumental).flac
│       ├── 10. あれこれドラスティック (Instrumental).flac
│       ├── 11. reprise (Instrumental).flac
│       ├── .album -> ../../.anni/objects/e1/5/e1057cfd-cd38-4280-bccf-4a48d4cf39f6
│       └── cover.jpg
└── .anni
    ├── config.toml
    ├── objects
    │   └── 10
    │       └── 77
    │           └── 1077d96b-8fd3-4585-a6ab-8eef265a48df
    │               ├── 1
    │               │   ├── 1.flac
    │               │   ├── 2.flac
    │               │   ├── 3.flac
    │               │   ├── 4.flac
    │               │   ├── 5.flac
    │               │   └── cover.jpg
    │               └── cover.jpg
    └── repo
```

观察上述目录结构中的 `[A] halca` 部分。用户部分有以下几个特征：

1. 专辑目录可以位于任意嵌套层级下。
2. 专辑目录名称满足[约定目录结构](../01.audio-convention/08.directory.md)中专辑目录的约束。
3. 在整理过程中，目录中所有文件都是普通文件。
   \
   如 `[220817][VVXX-01253] 誰彼スクランブル／あれこれドラスティック【Complete Edition】`。
4. 在文件基本已经确定后，可以通过命令将所有文件转移到受控目录中，原目录下仅保留该文件的符号链接。
   \
   如 `[210519][VVXX-01011] キミがいたしるし`。
5. 专辑的目录下都存在名为 `.album` 的符号链接，链接到受控目录中的实际专辑位置。
   \
   因此，不存在 `.album` 的目录会被 `anni` 忽略。`anni` 只会处理存在专辑指向的目录。

## 配置文件

工作空间中的配置文件可以用于记录与整理相关的配置。一个简单的配置文件样例如下所示：

```toml
[workspace]
publish-to = ["default", "drive"]

[library.default]
type = "file"
root = "/home/yesterday17/Music"
# layers = 2

[library.drive]
type = "drive"
type = "drive"
corpora = "drive"
drive-id = "xxxx"
```

## 命令

### init

初始化工作空间。

- [ ] 全新创建工作空间
- [x] `--repo`：从指定位置 `clone` 元数据仓库
- [x] `--repo-config`：使用元数据仓库的 `repo.toml` 作为工作空间的配置文件
    \
    创建从 `.anni/config.toml` 到 `.anni/repo/repo.toml` 的符号链接。

### status

查看工作空间的状态。

- [x] `-a`, `--album-id`：显示完整的 `Album ID`

### create

新建专辑目录。新建的专辑目录状态为**未跟踪**。

- [x] `-a`, `--album-id`：创建专辑的 `Album ID`
- [x] `-d`, `--disc-num`：创建专辑对应的光盘数量
- [x] `-n`, `--name`：创建专辑目录的名称
- [x] `-f`, `--force`：当创建目录的路径存在时，是否强制创建专辑目录

### add

将专辑的状态变更为提交。状态变更前，`anni` 会输出一些信息供对比。

- [x] `-t`, `--tags`：变更状态的同时，向元数据仓库导入音频中内嵌的元数据
- [x] `-y`, `--yes`：跳过信息检查
- [x] `d`, `--dry-run`：不实际变更专辑状态，仅运行流程。该属性搭配 `-t` 使用可以仅导入专辑元数据

### rm

从工作空间中删除某一专辑。

- [x] `-y`, `--yes`：跳过人工确认

### update

在提交状态下，对音频、封面或元数据进行部分更新。

- [x] `-t`, `--tags`：写入元数据

### publish

在提交状态下，将专辑的状态变更为完成。

专辑发布后，工作空间中的专辑目录将会被删除。专辑将会被转移到指定的音频仓库中。

当专辑目录中存在任意非符号链接的正常文件时，发布过程中止。

- [ ] `-c`, `--convention`：以约定目录结构发布源文件
- [ ] `--copy`：以复制的方式发布，不删除当前工作空间中的内容

### fsck

修复一些常见的工作空间问题。

1. [x] `-d`, `--fix-dangling`：修复状态为**悬垂**的专辑目录
2. [x] `--gc`：清除状态为**待回收**的专辑目录
